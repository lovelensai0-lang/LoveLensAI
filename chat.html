<!doctype html><html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>LoveLens AI Chat</title>
<style>
body{margin:0;font-family:Arial,sans-serif;background:#f8f0fc;display:flex;flex-direction:column;height:100vh}
header{background:linear-gradient(90deg,#ff6ec7 0%,#7a00ff 100%);color:#fff;padding:14px 18px;font-size:20px;display:flex;align-items:center;justify-content:space-between}
#chat{flex:1;overflow:auto;background:#fff;padding:16px}
.msg{max-width:70%;margin:8px 0;padding:12px;border-radius:12px;line-height:1.4}
.user{background:#e0d6ff;margin-left:auto;text-align:right}
.bot{background:#f7e6ff}
#bar{display:flex;gap:8px;padding:10px;background:#f3f3f3;border-top:1px solid #ddd}
#input{flex:1;padding:10px;font-size:16px;border:1px solid #ccc;border-radius:6px}
#send{padding:10px 16px;background:#f92772;color:#fff;border:0;border-radius:6px;cursor:pointer}
.note{font-size:13px;color:#b00020;margin:8px 12px 0}
a.btn{background:#fff;color:#f92772;padding:8px 14px;border-radius:18px;text-decoration:none;font-weight:700}
</style>
</head><body>
<header>
  <div>LoveLens AI Chat</div>
  <div><a class="btn" id="buyPass" style="display:none" href="#">Buy Access Pass</a></div>
</header>
<div id="chat"></div>
<div id="notice" class="note"></div>
<div id="bar"><input id="input" placeholder="Type..."><button id="send">Send</button></div>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script>
const chat=document.getElementById('chat'),input=document.getElementById('input'),send=document.getElementById('send');
const notice=document.getElementById('notice');let freeCount=0,unlimited=false;
function add(text,cls){const d=document.createElement('div');d.className='msg '+cls;d.textContent=text;chat.appendChild(d);chat.scrollTop=chat.scrollHeight;}
const replies=[
 "I‚Äôm here for you ‚ù§Ô∏è What‚Äôs on your mind?",
 "Tell me more‚ÄîI‚Äôm listening. üòä",
 "You deserve gentleness today. What would help?",
 "Thank you for sharing that. üíñ",
 "Let‚Äôs brighten your mood‚Äîsmall step together?"
];
function reply(){add(replies[Math.floor(Math.random()*replies.length)],'bot');}
function canSend(){ if(unlimited) return true; freeCount++; if(freeCount<=5) return true; notice.textContent="Premium required. Click ‚ÄòBuy Access Pass‚Äô to unlock unlimited chat."; return false;}

send.onclick=()=>{const t=input.value.trim(); if(!t) return; if(!canSend()) return; add(t,'user'); input.value=''; setTimeout(reply,500);};
input.addEventListener('keydown',e=>{if(e.key==='Enter') send.click();});

// Gating: real on-chain key via Unlock
(async ()=>{
  const cfg=await fetch('config.json').then(r=>r.json()).catch(()=>({}));
  const LOCK=(cfg.lockAddress||'').toLowerCase();
  const NET=cfg.network||80002;
  const RPC=cfg.rpcUrl||'https://polygon-amoy-bor-rpc.publicnode.com';
  // Resolve user address (either ?wallet=... or MetaMask)
  const url=new URL(location.href); let user=(url.searchParams.get('wallet')||'').toLowerCase();
  async function connect(){ if(!user && window.ethereum){ const acc=await ethereum.request({method:'eth_requestAccounts'}); user=(acc?.[0]||'').toLowerCase(); } return user; }
  async function hasValidKey(addr){
    if(!LOCK||!addr) return false;
    const abi=['function getHasValidKey(address) view returns (bool)'];
    const provider=new ethers.providers.JsonRpcProvider(RPC);
    const lock=new ethers.Contract(LOCK,abi,provider);
    try { return await lock.getHasValidKey(addr); } catch(e){ console.error(e); return false; }
  }
  await connect();
  if(await hasValidKey(user)){ unlimited=true; notice.remove(); }
  else {
    // Build Unlock checkout link
    if(LOCK){
      const paywall=encodeURIComponent(JSON.stringify({locks:{[LOCK]:{network:NET,name:'LoveLens Pass'}},title:'LoveLens AI Access',icon:location.origin+'/LoveLensAI/lovelens-logo.svg'}));
      const redirect=encodeURIComponent(location.origin + '/LoveLensAI/chat.html');
      const url=`https://app.unlock-protocol.com/checkout?paywallConfig=${paywall}&redirectUri=${redirect}`;
      const buy=document.getElementById('buyPass'); buy.href=url; buy.style.display='inline-block';
      notice.textContent="You have 5 free messages. Buy a pass to unlock unlimited.";
    } else { notice.textContent="Pass not configured yet. Check back soon."; }
  }
})();
</script>
</body></html>
